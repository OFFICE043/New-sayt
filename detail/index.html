import { supabase } from "../supabase.js";

const params = new URLSearchParams(window.location.search);
const animeId = params.get("id");

const titleEl = document.getElementById("anime-title");
const rasmEl = document.getElementById("anime-rasm");
const tavsifEl = document.getElementById("anime-tavsif");
const janrEl = document.getElementById("anime-janr");
const jamiEl = document.getElementById("anime-jami");
const chiqqanEl = document.getElementById("anime-chiqqan");
const downloadEl = document.getElementById("download");

const episodeButtons = document.getElementById("episode-buttons");
const player = document.getElementById("player");

const loginMessage = document.getElementById("login-message");
const commentForm = document.getElementById("comment-form");
const commentText = document.getElementById("comment-text");
const commentsList = document.getElementById("comments-list");

let currentUser = null;

// ðŸ”¹ Sessiyani tekshirish
async function checkSession() {
  const { data } = await supabase.auth.getSession();
  if (data.session) {
    currentUser = data.session.user;
    loginMessage.style.display = "none";
    commentForm.classList.remove("hidden");
  }
}

// ðŸ”¹ Anime ma'lumotini yuklash
async function loadAnime() {
  const { data, error } = await supabase
    .from("animes")
    .select("*")
    .eq("id", animeId)
    .single();

  if (error) {
    titleEl.textContent = "Xatolik: " + error.message;
    return;
  }

  titleEl.textContent = data.nomi;
  rasmEl.src = data.rasm_url;
  tavsifEl.textContent = data.tavsif;
  janrEl.textContent = data.janr;
  jamiEl.textContent = data.qismlar_soni;
  chiqqanEl.textContent = data.chiqqan_qismlar;
  downloadEl.href = data.yuklab_url;

  // Epizod tugmalari
  episodeButtons.innerHTML = "";
  if (data.episodes && data.episodes.length > 0) {
    data.episodes.forEach((url, index) => {
      const btn = document.createElement("button");
      btn.textContent = `${index + 1}-qism`;
      btn.addEventListener("click", () => playEpisode(url, index + 1));
      episodeButtons.appendChild(btn);
    });
  }
}

// ðŸ”¹ Epizod ijro etish va history saqlash
async function playEpisode(url, episodeNum) {
  player.src = url;
  player.play();

  if (currentUser) {
    await supabase.from("history").upsert({
      user_id: currentUser.id,
      anime_id: animeId,
      last_watched: episodeNum
    });
  }
}

// ðŸ”¹ Kommentlarni yuklash
async function loadComments() {
  const { data, error } = await supabase
    .from("comments")
    .select("*")
    .eq("anime_id", animeId)
    .order("created_at", { ascending: false });

  if (error) {
    commentsList.innerHTML = "<p>Xatolik: " + error.message + "</p>";
    return;
  }

  commentsList.innerHTML = "";
  data.forEach(c => {
    const div = document.createElement("div");
    div.classList.add("comment");
    div.innerHTML = `<b>${c.username || "Anonim"}:</b> ${c.text}`;
    commentsList.appendChild(div);
  });
}

// ðŸ”¹ Komment yuborish
commentForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser) {
    alert("Avval login qiling!");
    return;
  }

  const text = commentText.value.trim();
  if (!text) return;

  const { error } = await supabase.from("comments").insert({
    anime_id: animeId,
    user_id: currentUser.id,
    username: currentUser.email, // yoki username saqlash mumkin
    text
  });

  if (error) {
    alert("Xatolik: " + error.message);
  } else {
    commentText.value = "";
    loadComments();
  }
});

// ðŸ”¹ Boshlanish
checkSession();
loadAnime();
loadComments();
